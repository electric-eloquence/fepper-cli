#!/bin/bash

# Recurse up the directory tree to find the parent directory of a given file.
function findup () {
  test / == "$PWD" && return || test -e "$1" && echo -n "$PWD" && return || cd .. && findup "$1"
}

# First, try to find the parent directory of fepper.command.
fepper_dir=`findup fepper.command`

# If fepper.command not found, try to find tasker.js.
if [ "$fepper_dir" == "" ]; then
  fepper_dir=`findup tasker.js`
fi

# If fepper_dir still not found, exit.
if [ "$fepper_dir" == "" ]; then
  exit 1
fi

# Read some confs from conf.yml.
# Set default values.
app_dir="."
conf_file=""
kill_zombies=""

# Set conf_file location.
if [ ! -f ${fepper_dir}/tasker.js ]; then
  conf_file="${fepper_dir}/conf.yml"

  # Back up IFS
  IFS_DEFAULT=$IFS
  IFS=":"
  while read -r key value
  do
    if [ "$key" == "app_dir" ]; then
      app_dir=$value
    elif [ "$key" == "kill_zombies" ]; then
      if [[ $value == *"true" ]]; then
        kill_zombies=$value
      fi
    fi
  done < $conf_file

  # Revert IFS
  IFS=$IFS_DEFAULT
fi

# Only kill zombies on default task.
if [ "$1" == "" ] || [ "$1" == "default" ]; then
  if [ "$kill_zombies" != "" ]; then
    if pgrep -x gulp > /dev/null; then
      echo Killing lingering gulp process...
      killall gulp
    fi
    if pgrep -x node > /dev/null; then
      echo Killing lingering node process...
      killall node
    fi
  fi
fi

# Wrap arguments containing spaces in double-quotes.
s="[[:space:]]"
args=""
for i in "$@"; do
  if [[ $i =~ $s ]]; then
    args="$args \"$i\""
  else
    args="$args $i"
  fi
done

# Trim app_dir.
app_dir="${app_dir#"${app_dir%%[![:space:]]*}"}" # remove leading whitespace characters
app_dir="${app_dir%"${app_dir##*[![:space:]]}"}" # remove trailing whitespace characters

# Run index.js with arguments.
cd $fepper_dir
node ${fepper_dir}/${app_dir}/index.js $args
