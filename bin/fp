#!/bin/bash

# Recurse up the directory tree to find the parent directory of a given file.
function findup () {
  PWDP=`pwd -P`
  test / == "$PWDP" && return || test -e "$1" && echo -n "$PWDP" && return || cd .. && findup "$1"
}

# First, try to find the parent directory of fepper.command.
root_dir=`findup fepper.command`

# If fepper.command not found, try to find tasker.js.
if [ "$root_dir" == "" ]; then
  root_dir=`findup tasker.js`
fi

# If root_dir still not found, exit.
if [ "$root_dir" == "" ]; then
  echo It appears you are trying to run fp outside Fepper! Exiting!
  exit 1
fi

# Read some confs from conf.yml.
# Set default values.
app_dir="node_modules/fepper"
conf_file=""
kill_zombies=""

# Set conf_file location.
if [ ! -f ${root_dir}/tasker.js ]; then
  conf_file="${root_dir}/conf.yml"

  # Back up IFS
  IFS_DEFAULT=$IFS
  IFS=":"
  while read -r key value
  do

    # Trim whitespace from keys.
    key="${key#"${key%%[![:space:]]*}"}"
    key="${key%"${key##*[![:space:]]}"}"

    # Trim trailing inline comments from values.
    value="${value%%#*}"

    # Trim whitespace from values.
    value="${value#"${value%%[![:space:]]*}"}"
    value="${value%"${value##*[![:space:]]}"}"

    if [ "$key" == "app_dir" ]; then
      app_dir=$value
    elif [ "$key" == "kill_zombies" ]; then
      kill_zombies=$value
    fi
  done < $conf_file

  # Revert IFS
  IFS=$IFS_DEFAULT
fi

# Only kill zombies on default task.
if [ "$1" == "" ] || [ "$1" == "default" ]; then
  if [ "$kill_zombies" == "true" ]; then
    if pgrep -x gulp > /dev/null; then
      echo Killing lingering gulp process...
      killall gulp
    fi
    if pgrep -x node > /dev/null; then
      echo Killing lingering node process...
      killall node
    fi
  fi
fi

s="[[:space:]]"
args=""

for i in "$@"; do
  if [ "$i" == "--help" ] || [ "$i" == "-h" ]; then
    # Run task `help` if "$1" == "--help" or "-h"
    args="$args help"
  elif [ "$i" == "--version" ] || [ "$i" == "-v" ]; then
    # Run task `version` if "$1" == "--version" or "-v"
    args="$args version"
  elif [[ $i =~ $s ]]; then
    # Wrap arguments containing spaces in double-quotes.
    args="$args \"$i\""
  else
    args="$args $i"
  fi
done

args="$args --root_dir=$root_dir"

# Run index.js with arguments.
cd $root_dir
node ${root_dir}/${app_dir}/index.js $args
